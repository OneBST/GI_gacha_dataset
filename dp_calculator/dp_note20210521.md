# 原神抽卡出货概率的动态规划法计算

这个简单的动态规划方法适用于**计算抽取五星物品所需的抽数分布**。

对于四星物品，由于其与五星耦合到一起，直接计算会使得状态庞杂。可以不考虑五星的影响近似计算，可以在保证简洁的同时得到不错的结果。

## 角色活动祈愿的计算

### 状态定义

$ s[i][j][0]$表示抽了$i$抽时恰好抽到了五星，且此时抽到了$j$个UP五星角色，0表示**本次抽到的不是UP五星角色**

$ s[i][j][1]$表示抽了$i$抽时恰好抽到了五星，且此时抽到了$j$个UP五星角色，1表示**本次抽到的是UP五星角色**

有状态转移方程如下：
$$
\begin{align}
s[i][j][0]&=\frac{1}{2}\sum_{k=max(i-90,0)}^{i-1}{s[k][j][1]\cdot P_{trans}[i-k] }\tag{1}\\
s[i][j][1]&=\sum_{k=max(i-90,0)}^{i-1}{s[k][j-1][0]\cdot P_{trans}[i-k]}\\
&\quad+\frac{1}{2}\sum_{k=max(i-90,0)}^{i-1}{s[k][j-1][1]\cdot P_{trans}[i-k]}\tag{2}
\end{align}
$$
其中$P_{trans}[x]$表示刚好在第x抽抽到五星的概率$P_{trans}[x]=\prod_{m=1}^{x-1}{(1-P_{get}[m])}\cdot P_{get}[x]$ $P_{get}[m]$表示前$m-1$抽没有抽到五星时在第$m$抽抽到五星的概率。

$(1)$式表示本次没有抽到UP五星的概率只可能转移自于上次抽到了UP五星的状态，$(2)$式表示本次抽到UP五星的概率可能转移自上次没有抽到UP五星或上次抽到了UP五星两种情况

### 初始状态设置

设$s[0][0][1]$为1，因为还没有抽过卡的状态和上次刚抽到UP五星的状态对于抽取UP五星来说是等价的。

### 结果取出

完成DP计算后，根据状态的定义，$s[i][j][1]$就是第$i$抽时刚好抽到$j$个UP五星角色的概率。

将其累加，令$P_{sum}[i]=\sum_{x=1}^{i}{s[i][j][1]}$，$P_{sum}[i]$就是抽$i$抽，至少抽到$j$个UP五星角色的概率。

### 时间复杂度

DP过程复杂度为$O(ij)$，结果取出过程的复杂度为$O(i)$，理论上运行起来会很快。实际上由于我编写采用了Python并使用了糟糕的写法，导致运行速度比预期的缓慢。

## 武器活动祈愿的计算

### 状态定义

研究只想要两把五星武器其中一把的情况，相对于角色活动祈愿的状态定义进行小小的修改即可：

$ s[i][j][0]$表示抽了$i$抽时恰好抽到了五星，且此时抽到了$j$个想要的UP五星武器，0表示本次抽到的**不是UP五星武器**
$ s[i][j][1]$表示抽了$i$抽时恰好抽到了五星，且此时抽到了$j$个想要的UP五星武器，1表示本次抽到的是**想要的UP五星武器**

$ s[i][j][0]$表示抽了$i$抽时恰好抽到了五星，且此时抽到了$j$个想要的UP五星武器，0表示本次抽到的是**不想要的UP五星武器**

同样有类似的状态转移方程，这里就不写了。

## 常驻祈愿的计算

由于常驻祈愿中有使得五星武器和五星角色获得更均匀的机制，暂时不进行计算。

目前在数据中发现在常驻祈愿中，若连续获得很多五星武器，则更有概率获得五星角色。

## 四星的计算

由于使用动态规划计算四星的理论值会使得要定义的状态非常复杂，所以可以使用简化模型，不考虑五星的影响。这样的话修改一下武器池的方法即可。

